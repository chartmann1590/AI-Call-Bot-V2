{% extends "layout.html" %}

{% block title %}CallBot - Settings{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-cog me-2"></i>Settings</h1>
        <p class="text-muted">Configure CallBot's SIP, AI, and TTS settings.</p>
    </div>
</div>

<form method="POST" action="{{ url_for('settings') }}">
    <div class="row">
        <!-- SIP Configuration -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-phone me-2"></i>SIP Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="sip_domain" class="form-label">SIP Domain</label>
                        <input type="text" class="form-control" id="sip_domain" name="sip_domain" 
                               value="{{ settings.sip_domain }}" required>
                        <div class="form-text">Your SIP server domain (e.g., your-pbx-server.com)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sip_username" class="form-label">SIP Username</label>
                        <input type="text" class="form-control" id="sip_username" name="sip_username" 
                               value="{{ settings.sip_username }}" required>
                        <div class="form-text">Your SIP extension username</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sip_password" class="form-label">SIP Password</label>
                        <input type="password" class="form-control" id="sip_password" name="sip_password" 
                               value="{{ settings.sip_password }}" required>
                        <div class="form-text">Your SIP extension password</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="sip_port" class="form-label">SIP Port</label>
                        <input type="number" class="form-control" id="sip_port" name="sip_port" 
                               value="{{ settings.sip_port }}" min="1" max="65535" required>
                        <div class="form-text">SIP server port (usually 5060)</div>
                    </div>
                    
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="testSIPConnection()">
                            <i class="fas fa-phone me-1"></i>Test SIP Connection
                        </button>
                        <button type="button" class="btn btn-outline-warning" onclick="debugSIP()">
                            <i class="fas fa-bug me-1"></i>Debug SIP
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="compareSettings()">
                            <i class="fas fa-balance-scale me-1"></i>Compare Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Configuration -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-brain me-2"></i>AI Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="ollama_url" class="form-label">Ollama Server URL</label>
                        <input type="url" class="form-control" id="ollama_url" name="ollama_url" 
                               value="{{ settings.ollama_url }}" required>
                        <div class="form-text">Ollama server URL (e.g., http://localhost:11434)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="ollama_model" class="form-label">Ollama Model</label>
                        <select class="form-select" id="ollama_model" name="ollama_model" required>
                            <option value="">Select a model...</option>
                            {% for model in ollama_models %}
                                <option value="{{ model }}" {{ 'selected' if model == settings.ollama_model }}>
                                    {{ model }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">AI model to use for generating responses</div>
                    </div>
                    
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary" onclick="fetchOllamaModels()">
                            <i class="fas fa-sync-alt me-1"></i>Fetch Models
                        </button>
                        <button type="button" class="btn btn-outline-success" onclick="testOllamaConnection()">
                            <i class="fas fa-brain me-1"></i>Test AI Connection
                        </button>
                    </div>
                    
                    <div id="ollama-status" class="mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- TTS Configuration -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-volume-up me-2"></i>Text-to-Speech Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="tts_engine" class="form-label">TTS Engine</label>
                        <select class="form-select" id="tts_engine" name="tts_engine" required onchange="updateTTSVoices()">
                            <option value="">Select TTS engine...</option>
                            {% for engine_name, engine_info in tts_engines.items() %}
                                <option value="{{ engine_name }}" 
                                        {{ 'selected' if engine_name == settings.tts_engine }}
                                        data-available="{{ 'true' if engine_info.available else 'false' }}">
                                    {{ engine_info.name }} {{ '(Not Available)' if not engine_info.available }}
                                </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Text-to-speech engine to use</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="tts_voice" class="form-label">TTS Voice</label>
                        <select class="form-select" id="tts_voice" name="tts_voice" required>
                            <option value="">Select a voice...</option>
                        </select>
                        <div class="form-text">Voice to use for speech synthesis</div>
                    </div>
                    
                    <button type="button" class="btn btn-outline-info" onclick="testTTS()">
                        <i class="fas fa-volume-up me-1"></i>Test TTS
                    </button>
                </div>
            </div>
        </div>

        <!-- Whisper Configuration -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-microphone me-2"></i>Speech Recognition Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="whisper_model_size" class="form-label">Whisper Model Size</label>
                        <select class="form-select" id="whisper_model_size" name="whisper_model_size" required>
                            <option value="tiny" {{ 'selected' if settings.whisper_model_size == 'tiny' }}>Tiny (Fastest)</option>
                            <option value="base" {{ 'selected' if settings.whisper_model_size == 'base' }}>Base (Balanced)</option>
                            <option value="small" {{ 'selected' if settings.whisper_model_size == 'small' }}>Small (Better)</option>
                            <option value="medium" {{ 'selected' if settings.whisper_model_size == 'medium' }}>Medium (Best)</option>
                            <option value="large" {{ 'selected' if settings.whisper_model_size == 'large' }}>Large (Best Quality)</option>
                        </select>
                        <div class="form-text">Larger models are more accurate but slower</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="whisper_device" class="form-label">Whisper Device</label>
                        <select class="form-select" id="whisper_device" name="whisper_device" required>
                            <option value="cpu" {{ 'selected' if settings.whisper_device == 'cpu' }}>CPU</option>
                            <option value="cuda" {{ 'selected' if settings.whisper_device == 'cuda' }}>CUDA (GPU)</option>
                        </select>
                        <div class="form-text">Device to use for speech recognition</div>
                    </div>
                    
                    <button type="button" class="btn btn-outline-warning" onclick="testWhisper()">
                        <i class="fas fa-microphone me-1"></i>Test Whisper
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">Save Configuration</h6>
                            <small class="text-muted">Click save to apply all settings</small>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Test Results Modal -->
<div class="modal fade" id="testResultsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="testResultsContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// TTS engine voices mapping
const ttsVoices = {
    {% for engine_name, engine_info in tts_engines.items() %}
        '{{ engine_name }}': {{ engine_info.voices | tojson }},
    {% endfor %}
};

// Initialize TTS voices on page load
$(document).ready(function() {
    updateTTSVoices();
});

function updateTTSVoices() {
    const selectedEngine = $('#tts_engine').val();
    const voiceSelect = $('#tts_voice');
    const currentVoice = '{{ settings.tts_voice }}';
    
    // Clear current options
    voiceSelect.empty();
    voiceSelect.append('<option value="">Select a voice...</option>');
    
    if (selectedEngine && ttsVoices[selectedEngine]) {
        ttsVoices[selectedEngine].forEach(voice => {
            const option = $('<option></option>')
                .val(voice)
                .text(voice)
                .prop('selected', voice === currentVoice);
            voiceSelect.append(option);
        });
    }
}

function testOllamaConnection() {
    const url = $('#ollama_url').val();
    const model = $('#ollama_model').val();
    
    if (!url || !model) {
        alert('Please enter both Ollama URL and model');
        return;
    }
    
    $('#ollama-status').html('<div class="spinner-border spinner-border-sm text-primary"></div> Testing connection...');
    
    $.get('/api/test_ollama')
        .done(function(data) {
            let statusHtml = '';
            if (data.connected) {
                statusHtml = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>Connection successful!
                        <br><small>Available models: ${data.models.join(', ')}</small>
                    </div>
                `;
            } else {
                statusHtml = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>Connection failed: ${data.error || 'Unknown error'}
                    </div>
                `;
            }
            $('#ollama-status').html(statusHtml);
        })
        .fail(function() {
            $('#ollama-status').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>Failed to test connection
                </div>
            `);
        });
}

function fetchOllamaModels() {
    const url = $('#ollama_url').val();
    
    if (!url) {
        return;
    }
    
    // Show loading state
    const modelSelect = $('#ollama_model');
    const currentValue = modelSelect.val();
    
    modelSelect.html('<option value="">Loading models...</option>');
    modelSelect.prop('disabled', true);
    
    $.ajax({
        url: '/api/fetch_ollama_models',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ ollama_url: url }),
        success: function(data) {
            modelSelect.prop('disabled', false);
            
            if (data.success && data.models.length > 0) {
                // Clear and populate with new models
                modelSelect.html('<option value="">Select a model...</option>');
                
                data.models.forEach(function(model) {
                    const option = $('<option></option>')
                        .val(model)
                        .text(model)
                        .prop('selected', model === currentValue);
                    modelSelect.append(option);
                });
                
                // Show success message
                $('#ollama-status').html(`
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>Successfully loaded ${data.count} models from ${url}
                    </div>
                `);
            } else {
                // Reset to original state
                modelSelect.html('<option value="">Select a model...</option>');
                if (currentValue) {
                    modelSelect.append(`<option value="${currentValue}" selected>${currentValue}</option>`);
                }
                
                // Show error message
                const errorMsg = data.error || 'No models found';
                $('#ollama-status').html(`
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>Could not load models: ${errorMsg}
                    </div>
                `);
            }
        },
        error: function() {
            modelSelect.prop('disabled', false);
            modelSelect.html('<option value="">Select a model...</option>');
            if (currentValue) {
                modelSelect.append(`<option value="${currentValue}" selected>${currentValue}</option>`);
            }
            
            $('#ollama-status').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>Failed to fetch models from ${url}
                </div>
            `);
        }
    });
}

function testSIPConnection() {
    const domain = $('#sip_domain').val();
    const username = $('#sip_username').val();
    const password = $('#sip_password').val();
    
    if (!domain || !username || !password) {
        alert('Please enter all SIP configuration fields');
        return;
    }
    
    // Show loading state
    $('#testResultsContent').html(`
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Testing SIP connection...</span>
            </div>
            <p class="mt-2">Testing SIP connection to ${domain}...</p>
        </div>
    `);
    $('#testResultsModal').modal('show');
    
    // Test SIP connection
    $.get('/api/test_sip')
        .done(function(data) {
            let resultHtml = '';
            if (data.connected) {
                resultHtml = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>${data.message}
                        <br><small>Domain: ${data.domain}, Username: ${data.username}</small>
                    </div>
                `;
            } else {
                resultHtml = `
                    <div class="alert alert-danger">
                        <i class="fas fa-times-circle me-2"></i>Connection failed: ${data.error}
                        <br><small>Domain: ${data.domain}, Username: ${data.username}</small>
                    </div>
                `;
            }
            $('#testResultsContent').html(resultHtml);
        })
        .fail(function() {
            $('#testResultsContent').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>Failed to test SIP connection
                </div>
            `);
        });
}

function debugSIP() {
    $('#testResultsContent').html(`
        <div class="text-center">
            <div class="spinner-border text-warning" role="status">
                <span class="visually-hidden">Debugging SIP...</span>
            </div>
            <p class="mt-2">Getting SIP debug information...</p>
        </div>
    `);
    $('#testResultsModal').modal('show');
    
    $.get('/api/debug_sip')
        .done(function(data) {
            let debugHtml = '<h6>SIP Debug Information:</h6><pre class="bg-light p-3">';
            debugHtml += JSON.stringify(data, null, 2);
            debugHtml += '</pre>';
            $('#testResultsContent').html(debugHtml);
        })
        .fail(function() {
            $('#testResultsContent').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>Failed to get SIP debug information
                </div>
            `);
        });
}

function compareSettings() {
    $('#testResultsContent').html(`
        <div class="text-center">
            <div class="spinner-border text-info" role="status">
                <span class="visually-hidden">Comparing settings...</span>
            </div>
            <p class="mt-2">Comparing main app vs test endpoint settings...</p>
        </div>
    `);
    $('#testResultsModal').modal('show');
    
    $.get('/api/compare_sip_settings')
        .done(function(data) {
            let compareHtml = '<h6>Settings Comparison:</h6><pre class="bg-light p-3">';
            compareHtml += JSON.stringify(data, null, 2);
            compareHtml += '</pre>';
            $('#testResultsContent').html(compareHtml);
        })
        .fail(function() {
            $('#testResultsContent').html(`
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>Failed to compare settings
                </div>
            `);
        });
}

function testTTS() {
    const engine = $('#tts_engine').val();
    const voice = $('#tts_voice').val();
    
    if (!engine || !voice) {
        alert('Please select both TTS engine and voice');
        return;
    }
    
    $('#testResultsContent').html(`
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>TTS testing will be available when the application is running.
            <br><small>Engine: ${engine}, Voice: ${voice}</small>
        </div>
    `);
    $('#testResultsModal').modal('show');
}

function testWhisper() {
    const modelSize = $('#whisper_model_size').val();
    const device = $('#whisper_device').val();
    
    if (!modelSize || !device) {
        alert('Please select both Whisper model size and device');
        return;
    }
    
    $('#testResultsContent').html(`
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>Whisper testing will be available when the application is running.
            <br><small>Model: ${modelSize}, Device: ${device}</small>
        </div>
    `);
    $('#testResultsModal').modal('show');
}

// Auto-save form data to localStorage
$('form input, form select').on('change', function() {
    const formData = {};
    $('form input, form select').each(function() {
        formData[$(this).attr('name')] = $(this).val();
    });
    localStorage.setItem('callbot_settings', JSON.stringify(formData));
});

// Restore form data from localStorage
$(document).ready(function() {
    const savedData = localStorage.getItem('callbot_settings');
    if (savedData) {
        const formData = JSON.parse(savedData);
        Object.keys(formData).forEach(key => {
            $(`[name="${key}"]`).val(formData[key]);
        });
        updateTTSVoices();
    }
    
    // Auto-fetch models when Ollama URL changes
    $('#ollama_url').on('change', function() {
        // Add a small delay to avoid too many requests
        clearTimeout(window.ollamaUrlTimeout);
        window.ollamaUrlTimeout = setTimeout(function() {
            fetchOllamaModels();
        }, 500);
    });
});
</script>
{% endblock %} 