{% extends "layout.html" %}

{% block title %}CallBot - Conversations{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-comments me-2"></i>Conversations</h1>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary" onclick="refreshCalls()">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
                <button type="button" class="btn btn-outline-success" onclick="exportCalls()">
                    <i class="fas fa-download me-1"></i>Export
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" action="{{ url_for('conversations') }}" id="search-form">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" name="search" 
                                       value="{{ search }}" placeholder="Search transcripts, responses, or caller IDs...">
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-search me-1"></i>Search
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" name="status" onchange="this.form.submit()">
                                <option value="">All Status</option>
                                <option value="completed" {{ 'selected' if request.args.get('status') == 'completed' }}>Completed</option>
                                <option value="in_progress" {{ 'selected' if request.args.get('status') == 'in_progress' }}>In Progress</option>
                                <option value="failed" {{ 'selected' if request.args.get('status') == 'failed' }}>Failed</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Calls Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Call History
                    <span class="badge bg-primary ms-2">{{ calls.total }}</span>
                </h5>
            </div>
            <div class="card-body p-0">
                {% if calls.items %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Date/Time</th>
                                <th>Caller ID</th>
                                <th>Duration</th>
                                <th>Transcript</th>
                                <th>AI Response</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for call in calls.items %}
                            <tr data-call-id="{{ call.id }}">
                                <td>
                                    <small class="text-muted">
                                        {{ call.timestamp.strftime('%Y-%m-%d') }}<br>
                                        {{ call.timestamp.strftime('%H:%M:%S') }}
                                    </small>
                                </td>
                                <td>
                                    <strong>{{ call.caller_id }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ call.duration_formatted }}</span>
                                </td>
                                <td>
                                    {% if call.transcript %}
                                        <div class="transcript-preview" data-transcript="{{ call.transcript }}">
                                            {{ call.transcript[:100] }}{% if call.transcript|length > 100 %}...{% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">No transcript</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if call.ai_response %}
                                        <div class="response-preview" data-response="{{ call.ai_response }}">
                                            {{ call.ai_response[:100] }}{% if call.ai_response|length > 100 %}...{% endif %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">No response</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if call.status == 'completed' else 'warning' if call.status == 'in_progress' else 'danger' }}">
                                        {{ call.status }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary" 
                                                onclick="viewCallDetails({{ call.id }})" 
                                                title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if call.audio_filename %}
                                        <button type="button" class="btn btn-outline-success" 
                                                onclick="playAudio({{ call.id }})" 
                                                title="Play Audio">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        {% endif %}
                                        <button type="button" class="btn btn-outline-info" 
                                                onclick="copyTranscript({{ call.id }})" 
                                                title="Copy Transcript">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No conversations found</h5>
                    <p class="text-muted">Calls will appear here once they are received and processed.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if calls.pages > 1 %}
<div class="row mt-4">
    <div class="col-12">
        <nav aria-label="Call history pagination">
            <ul class="pagination justify-content-center">
                {% if calls.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('conversations', page=calls.prev_num, search=search) }}">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    </li>
                {% endif %}
                
                {% for page_num in calls.iter_pages() %}
                    {% if page_num %}
                        <li class="page-item {{ 'active' if page_num == calls.page else '' }}">
                            <a class="page-link" href="{{ url_for('conversations', page=page_num, search=search) }}">
                                {{ page_num }}
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if calls.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('conversations', page=calls.next_num, search=search) }}">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>
{% endif %}

<!-- Call Details Modal -->
<div class="modal fade" id="callDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-phone me-2"></i>Call Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="callDetailsContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Audio player
let currentAudio = null;

function viewCallDetails(callId) {
    // Load call details via AJAX
    $.get(`/api/calls/${callId}`)
        .done(function(data) {
            const call = data;
            const modalContent = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Call Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Caller ID:</strong></td><td>${call.caller_id}</td></tr>
                            <tr><td><strong>Date/Time:</strong></td><td>${new Date(call.timestamp).toLocaleString()}</td></tr>
                            <tr><td><strong>Duration:</strong></td><td>${call.duration_formatted}</td></tr>
                            <tr><td><strong>Status:</strong></td><td><span class="badge bg-${call.status === 'completed' ? 'success' : 'warning'}">${call.status}</span></td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Audio</h6>
                        ${call.audio_filename ? 
                            `<audio controls class="w-100">
                                <source src="/api/audio/${call.id}" type="audio/wav">
                                Your browser does not support the audio element.
                            </audio>` : 
                            '<p class="text-muted">No audio available</p>'
                        }
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Transcript</h6>
                        <div class="border rounded p-3 bg-light">
                            ${call.transcript || '<span class="text-muted">No transcript available</span>'}
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>AI Response</h6>
                        <div class="border rounded p-3 bg-light">
                            ${call.ai_response || '<span class="text-muted">No AI response available</span>'}
                        </div>
                    </div>
                </div>
            `;
            $('#callDetailsContent').html(modalContent);
            $('#callDetailsModal').modal('show');
        })
        .fail(function() {
            alert('Failed to load call details');
        });
}

function playAudio(callId) {
    // Stop any currently playing audio
    if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
    }
    
    // Create new audio element
    currentAudio = new Audio(`/api/audio/${callId}`);
    currentAudio.play().catch(function(error) {
        console.error('Audio playback failed:', error);
        alert('Failed to play audio');
    });
}

function copyTranscript(callId) {
    // Find the call row and get transcript
    const row = $(`tr[data-call-id="${callId}"]`);
    const transcript = row.find('.transcript-preview').data('transcript');
    
    if (transcript) {
        navigator.clipboard.writeText(transcript).then(function() {
            // Show success message
            const btn = $(`button[onclick="copyTranscript(${callId})"]`);
            const originalIcon = btn.html();
            btn.html('<i class="fas fa-check"></i>');
            setTimeout(function() {
                btn.html(originalIcon);
            }, 1000);
        }).catch(function() {
            alert('Failed to copy transcript');
        });
    }
}

function refreshCalls() {
    location.reload();
}

function exportCalls() {
    // Create CSV export
    const searchParams = new URLSearchParams(window.location.search);
    const url = `/api/calls?${searchParams.toString()}&export=csv`;
    
    // Download the CSV file
    const link = document.createElement('a');
    link.href = url;
    link.download = 'callbot_conversations.csv';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Auto-refresh active calls
setInterval(function() {
    // Update any "in_progress" calls
    $('.badge.bg-warning').each(function() {
        const callId = $(this).closest('tr').data('call-id');
        // Could implement real-time updates here
    });
}, 5000);
</script>
{% endblock %} 